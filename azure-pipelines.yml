trigger:
- main

variables:
  pythonVersion: '3.11'
  imageName: 'hellosre-api'
  location: 'Central India'
  project: 'hellosre'

  # IMPORTANT: change this to a globally unique ACR name (lowercase)
  acrName: 'hellosreacr12345'

  # Terraform working dir
  tfDir: 'infra'

stages:
- stage: CI
  displayName: "CI: Test"
  jobs:
  - job: test
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
    - script: |
        python -m pip install --upgrade pip
        pip install -r app/requirements.txt
        pip install pytest
        pytest -q
      displayName: "Run unit tests"

- stage: BuildPush
  displayName: "Build & Push Image to ACR"
  dependsOn: CI
  jobs:
  - job: docker
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: "Login ACR and build/push image"
      inputs:
        azureSubscription: 'azure-sc-hellosre'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          az acr show -n $(acrName) >/dev/null 2>&1 || \
            az acr create -n $(acrName) -g $(project)-rg -l "$(location)" --sku Basic --admin-enabled true || true

          ACR_LOGIN_SERVER=$(az acr show -n $(acrName) --query loginServer -o tsv)
          echo "ACR: $ACR_LOGIN_SERVER"

          az acr login -n $(acrName)

          TAG=$(Build.BuildId)
          docker build -t $ACR_LOGIN_SERVER/$(imageName):$TAG .
          docker push $ACR_LOGIN_SERVER/$(imageName):$TAG

          echo "##vso[task.setvariable variable=imageTag;isOutput=true]$TAG"
      name: acrStep

- stage: Deploy
  displayName: "Deploy: Terraform Apply"
  dependsOn: BuildPush
  variables:
    imageTag: $[ stageDependencies.BuildPush.docker.outputs['acrStep.imageTag'] ]
  jobs:
  - job: terraform
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: "Terraform init/plan/apply"
      inputs:
        azureSubscription: 'azure-sc-hellosre'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          az --version

          # Create RG if not exists
          az group create -n $(project)-rg -l "$(location)" >/dev/null

          # Install terraform
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install -y terraform

          cd $(tfDir)

          terraform init
          terraform plan \
            -var="location=$(location)" \
            -var="project=$(project)" \
            -var="acr_name=$(acrName)" \
            -var="image_name=$(imageName)" \
            -var="image_tag=$(imageTag)"

          terraform apply -auto-approve \
            -var="location=$(location)" \
            -var="project=$(project)" \
            -var="acr_name=$(acrName)" \
            -var="image_name=$(imageName)" \
            -var="image_tag=$(imageTag)"

          echo "Deployed URL:"
          terraform output -raw webapp_url